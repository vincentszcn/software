<html><!-- #BeginTemplate "/Templates/template.dwt" -->
<head>
<!-- #BeginEditable "doctitle" --> 
<title>Sysinternals Freeware - Information for Windows NT and Windows 2000 - Tokenmon</title>
<!-- #EndEditable --> 
<meta http-equiv="Content-Type" content="text/html;">
<script language="JavaScript">
<!--
function MM_swapImgRestore() { //v3.0
  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
}

function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}

function MM_swapImage() { //v3.0
  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
}

function MM_findObj(n, d) { //v4.0
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && document.getElementById) x=document.getElementById(n); return x;
}
//-->
</script>
<link rel=stylesheet href="../../includes/default.css" type="text/css">
</head>
<body topmargin="0" leftmargin="0" marginheight="0" marginwidth="0" bgcolor="#ffffff" background="../../images/background.gif"   onLoad="MM_preloadImages('../../images/topmenu_images/otop_menu_resources.gif','../../images/topmenu_images/otop_menu_aboutus.gif','../../images/topmenu_images/otop_menu_global.gif','../../images/sidemenu_images/oside_menu_98_utilities.gif','../../images/sidemenu_images/oside_menu_utilities.gif','../../images/sidemenu_images/oside_menu_source.gif','../../images/sidemenu_images/oside_menu_information.gif','../../images/sidemenu_images/oside_menu_98_source.gif','../../images/sidemenu_images/oside_menu_98_information.gif','../../images/topmenu_images/otop_menu_resources.gif','../../images/topmenu_images/otop_menu_sitemap.gif','../../images/topmenu_images/otop_menu_licensing.gif','../../images/topmenu_images/otop_menu_aboutus.gif','../../images/topmenu_images/otop_menu_global.gif')">
<table width="770" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td rowspan="4" width="226" valign="top"> 
      <table width="50" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td><a href="../../index.shtml"><img src="../../images/logo.gif" width="227" height="67" border="0"></a></td>
        </tr>
        <tr valign="top"> 
          <td height="479"><SCRIPT LANGUAGE="JavaScript1.2" TYPE="text/javascript">
<!--
	JM_DOM = (document.getElementById) ? true : false;
	JM_NS4 = (document.layers) ? true : false;
	JM_NS4old = (JM_NS4 && (parseFloat(navigator.appVersion) < 4.02));
	JM_IE = (document.all) ? true : false;
	JM_IE4 = JM_IE && !JM_DOM;
	JM_IE4M = JM_IE4 && JM_Mac;
	JM_IsMenu = (JM_DOM || (JM_NS4 && !JM_NS4old) || (JM_IE && !JM_IE4M));

	
	if ((JM_NS4 || JM_DOM) && !JM_IE) {
		searchWidth = 7;
		emailWidth= 12;
		vgmWidth = 7;
	} else {
		searchWidth = 14;
		emailWidth= 14;
		vgmWidth = 11;
	}
//-->
</SCRIPT>
<table width="176" border="0" cellspacing="0" cellpadding="0" height="279">
  <tr valign="top"> 
    <td height="291"><img src="../../images/sidemenu_images/side_menu_top.gif" width="179" height="92" align="top"><br>
      <a href="../../ntw2k/utilities.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image16','','../../images/sidemenu_images/oside_menu_utilities.gif',1)"><img name="Image16" border="0" src="../../images/sidemenu_images/side_menu_utilities.gif" width="179" height="23" align="top"></a> 
      <a href="../../ntw2k/source.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image11','','../../images/sidemenu_images/oside_menu_source.gif',1)"><img name="Image11" border="0" src="../../images/sidemenu_images/side_menu_source.gif" width="179" height="22" align="top"></a> 
      <a href="../../ntw2k/information.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image12','','../../images/sidemenu_images/oside_menu_information.gif',1)"><img name="Image12" border="0" src="../../images/sidemenu_images/side_menu_information.gif" width="179" height="27" align="top"></a> 
      <img src="../../images/sidemenu_images/side_menu_middle.gif" width="179" height="50" align="top"><br>
      <a href="../../win9x/98utilities.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image13','','../../images/sidemenu_images/oside_menu_98_utilities.gif',1)"><img name="Image13" border="0" src="../../images/sidemenu_images/side_menu_98_utilities.gif" width="179" height="18" align="top"></a> 
      <a href="../../win9x/98source.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image14','','../../images/sidemenu_images/oside_menu_98_source.gif',1)"><img name="Image14" border="0" src="../../images/sidemenu_images/side_menu_98_source.gif" width="179" height="26" align="top"></a> 
      <a href="../../win9x/98information.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image15','','../../images/sidemenu_images/oside_menu_98_information.gif',1)"><img name="Image15" border="0" src="../../images/sidemenu_images/side_menu_98_information.gif" width="179" height="24" align="top"></a> 
      <img src="../../images/sidemenu_images/side_menu_linux.gif" width="179" height="50" border="0" align="top"><br>
      <a href="../../linux/utilities.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image131','','../../images/sidemenu_images/oside_menu_98_utilities.gif',1)"><img name="Image131" border="0" src="../../images/sidemenu_images/side_menu_98_utilities.gif" width="179" height="18" align="top"></a> <br><br>
    </td>
  <tr>
    <td valign="bottom"> 
      <form method="get" action="http://search.atomz.com/search/">
        <img src="../../images/sidemenu_images/side_menu_search.gif" width="179" height="25" border="0" align="top"> 
        <img src="/images/spacer.gif" width="10" height="5"> 
        <script language="JavaScript">document.write("<input type='text' size=" + searchWidth + " name='sp-q'>")</script>
        &nbsp;
        <input type="image" border="0" name="Sign Up!2" src="../../images/sidemenu_images/go.gif" width="35" height="20" alt="Sign Up!" class="floatright"  align="absmiddle">
        <input type=hidden name="sp-a" value="sp1000b352">
      </form>
    </td>
 </tr> 
</table>

 </td>
        </tr>
      </table>
    </td>
    <td colspan="2" valign="top"> 
      <table width="50" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td><img src="../../images/top_arch.gif" width="581" height="48" align="bottom"></td>
        </tr>
        <tr valign="top"> 
          <td valign="top"><table width="581" border="0" cellspacing="0" cellpadding="0" height="48">
  <tr valign="top"> 
    <td><a href="../../othresources.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image7','','../../images/topmenu_images/otop_menu_resources.gif',1)"><img name="Image7" border="0" src="../../images/topmenu_images/top_menu_resources.gif" width="115" height="45" align="top"></a><a href="../../sitemap.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image8','','../../images/topmenu_images/otop_menu_sitemap.gif',1)"><img name="Image8" border="0" src="../../images/topmenu_images/top_menu_sitemap.gif" width="91" height="45" align="top"></a><a href="../../licensing.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image9','','../../images/topmenu_images/otop_menu_licensing.gif',1)"><img name="Image9" border="0" src="../../images/topmenu_images/top_menu_licensing.gif" width="75" height="45" align="top"></a><a href="../../aboutus.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image6','','../../images/topmenu_images/otop_menu_aboutus.gif',1)"><img src="../../images/topmenu_images/filler.gif" width="6" height="45" align="top" border="0"><img name="Image6" border="0" src="../../images/topmenu_images/top_menu_aboutus.gif" width="75" height="45" align="top"></a><a href="../../index.shtml" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('Image192','','../../images/topmenu_images/otop_menu_home.gif',1)"><img name="Image192" border="0" src="../../images/topmenu_images/top_menu_home.gif" width="61" height="45" align="top"></a><img src="../../images/topmenu_images/top_menu_filler.gif" width="37" height="45" align="top"><img src="../../images/topmenu_images/top_menu_end.gif" width="121" height="45" align="top"></td>
  </tr>
</table>

            <!-- #BeginEditable "Section%20title/logo" --><i><b><img
src="../../images/logos/tokenmon.gif" alt="Logo" width="167" height="25"><font face="arial" size="2"><a name='top'></a><br>
            </font></b></i><b>Copyright &copy; 2000&nbsp;<a href="mailto:mark@sysinternals.com">Mark 
            Russinovich</a></b><!-- #EndEditable --></td>
        </tr>
      </table>
    </td>
  </tr>
  <tr> 
    <td colspan="2" valign="top"> 
      <table width="570" border="0" cellspacing="0" cellpadding="0">
        <tr valign="top"> 
          <td colspan="3" height="429"><!-- #BeginEditable "Body" -->
            <TABLE CELLSPACING="10" CELLPADDING="0" WIDTH="408">
              <TR valign="top" align="left"> 
                <TD COLSPAN="2" width="651"> 
                  <table width="580" border="0" cellspacing="0" cellpadding="0">
                    <tr> 
                      <td valign="top"> 
                        <table width="549" border="0" cellspacing="0" cellpadding="0" dwcopytype="CopyTableRow">
                          <tr> 
                            <td colspan="3"><b></b></td>
                          </tr>
                          <tr> 
                            <td colspan="3" valign="top"><span class='include'>Last 
                              updated September 21, 2000 v1.01</span>
                              <hr>
                            </td>
                          </tr>
                          <tr> 
                            <td colspan="3" height="40" valign="middle"><span class='sectionheader'>Introduction</span></td>
                          </tr>
                          <tr> 
                            <td valign="TOP" colspan="3" align="left"><i>Tokenmon</i> 
                              is a application that monitors and displays a variety 
                              of security-related activity taking place on a system. 
                              <i>Tokenmon</i> gets its name from the fact that 
                              Windows NT/2000 stores a process' security information, 
                              including the user account context in which the 
                              process executes, in an object called a <i>token</i>. 
                              <i>Tokenmon</i> monitors includes the following: 
                              <ul>
                                <li>User logon/logoff</li>
                                <li>Applications enabling or disabling security 
                                  privileges in their process tokens</li>
                                <li>Process startup and exit (token creation/deletion)</li>
                                <li>Impersonation</li>
                              </ul>
                              <p><i>Tokenmon</i> has advanced filtering and search 
                                capabilities that make it a powerful tool for 
                                exploring the way NT works, seeing how applications 
                                use security functions, or tracking down problems 
                                in system or application configurations. </p>
                              <p><em>Tokenmon</em> works on NT 4.0 and Windows 
                                2000.<br>
                                <br>
                                <img src="../../images/screenshots/tokeshot.gif" width="549" height="273"> 
                            </td>
                          </tr>
                          <tr> 
                            <td colspan="3" height="40" valign="middle"><span class='sectionheader'>Installation 
                              and Use </span></td>
                          </tr>
                          <tr> 
                            <td valign="TOP" colspan="3"> Simply run the <i>Tokenmon</i> 
                              GUI (Tokenmon.exe). Note that you must have administrative 
                              privilege to run <i>Tokenmon</i>. Menus, hot-keys, 
                              or toolbar buttons can be used to clear the window, 
                              save the monitored data to a file, and to filter 
                              and search output. 
                              <p>When a thread impersonates you'll see the thread's 
                                primary identity in the domain\user column and 
                                the identity its adopting in the Other column. 
                                Any security actions it performs at that point 
                                are in the impersonation context. When it reverts 
                                back to its own identity the thread's primary 
                                identity is again shown in the domain\user column.</p>
                              <p>As events are printed to the output, they are 
                                tagged with a sequence number. If <i>Tokenmon's</i> 
                                internal buffers are overflowed during extremely 
                                heavy activity, this will be reflected with gaps 
                                in the sequence number.</p>
                              <p>Each time you exit <i>Tokenmon</i> it remembers 
                                the position of the window and the widths of the 
                                output columns. 
                            </td>
                          </tr>
                          <tr> 
                            <td height="40" colspan="3" valign="middle"><span class='sectionheader'>How 
                              Tokenmon Works</span> </td>
                          </tr>
                          <tr> 
                            <td colspan="3" valign="TOP"> <i>Tokenmon</i> intercepts 
                              logon by hooking the <b>NtCreateToken</b> native 
                              API. The local security authority uses this API 
                              to create an initial login token when a user logs 
                              in either remotely or locally. When a user logs 
                              on the Local Security Authority Subsystem (LSASS) 
                              assigns the logon session a locally unique identifer 
                              (LUID) called a logon ID. To see a corresponding 
                              logoff, Tokenmon registers with the Security Reference 
                              Monitor (SRM) using the <b>SeRegisterLogonSessionTerminatedRoutine</b> 
                              kernel function, which requests that the SRM call 
                              the driver back whenever a user is logged off. 
                              <p>In order to see a process enable and disable 
                                privileges, <i>Tokenmon</i> hooks the <b>NtAdjustPrivilegesToken</b> 
                                function, which is the native API-equivalent of 
                                the Win32 <b>AdjustTokenPrivileges</b> functions. 
                                This function takes an array of privileges with 
                                a flag for each indicating whether the process 
                                wants to enable or disable it. Tokenmon shows 
                                the action for each privilege affected by a single 
                                call in separate output lines.</p>
                              <p><i>Tokenmon</i> uses the <b>PsSetCreateProcessNotifyRoutine</b> 
                                kernel function, which is documented in the Windows 
                                2000 DDK (but available on NT 4), to register 
                                a callback function whenever a process starts 
                                or exits. </p>
                              <p>Finally, there are several functions that applications 
                                can use to impersonate another user. <i>Tokenmon</i> 
                                hooks <b>NtSetInformationThread</b>, a variant 
                                of which is the native API-equivalent of the <b>ImpersonateLoggedOnUser</b> 
                                and <b>ImpersonateSelf</b> Win32 APIs, the FSCTL_PIPE_IMPERSONATE 
                                variant of <b>NtFsControlFile</b> (the native-equivalent 
                                of <b>ImpersonateNamedPipeClient</b>), and <b>NtImpersonateClientOfPort</b>, 
                                which is called by applications using the Local 
                                Procedure Call (LPC) facility and local RPC for 
                                impersonating the remote end of a LPC connection.</p>
                              <p><i>Tokenmon</i> relies on several undocumented 
                                SRM functions to obtain a logon ID from a thread's 
                                primary and impersonation tokens, and <b>GetSecurityUserInfo</b>, 
                                an undocumented function exported by the <i>KSecDD</i> 
                                (Kernel Security-support driver) that retrieves 
                                a logon session user's name, domain name, and 
                                logon server given a logon ID. Another interesting 
                                implementation detail is that several of the native 
                                API functions that <i>Tokenmon</i> hooks are not 
                                exported by ntoskrnl.exe for use by drivers. Thus, 
                                the <i>Tokenmon</i> GUI must reach into NTDLL.DLL, 
                                extract their system call numbers, and pass them 
                                to the driver. This contrasts with <a href="../../ntw2k/source/regmon.shtml">Regmon</a>, 
                                which reaches into ntoskrnl.exe using Registry 
                                function exports to obtain system call numbers.</p>
                              <p>See <a
href="../../insidew2k.shtml">Inside Windows 2000, 3rd Edition</a> by David Solomon 
                                and Mark Russinovich (Microsoft Press) for more 
                                information on the Windows NT/2000 security subsystem. 
                            </td>
                          </tr>
                          <tr> 
                            <td colspan="3" height="40" valign="middle"><span class='sectionheader'>Related 
                              Utilities </span></td>
                          </tr>
                          <tr> 
                            <td valign="TOP" colspan="3" align="left"> Here are 
                              some other monitoring tools available at Sysinternals: 
                              <ul>
                                <li><font color="#000000"><a href="../../ntw2k/source/regmon.shtml">Regmon</a> 
                                  - a Registry monitor</font></li>
                                <li><a href="../../ntw2k/source/filemon.shtml">Filemon</a> 
                                  - a file system monitor</li>
                                <li><a href="../../ntw2k/freeware/tdimon.shtml">TDImon</a> 
                                  - a TCP/IP monitor</li>
                                <li><a href="../../ntw2k/freeware/portmon.shtml">Portmon</a> 
                                  - a serial and parallel port monitor</li>
                                <li><a href="../../ntw2k/freeware/pmon.shtml">PMon</a> 
                                  - a process and thread monitor (NT/Win2K)</li>
                                <li><a href="../../ntw2k/freeware/diskmon.shtml">Diskmon</a> 
                                  - a hard disk monitor (NT/Win2K)</li>
                                <li><a href="../../ntw2k/freeware/debugview.shtml">DebugView/EE</a> 
                                  - a debug output monitor</li>
                              </ul>
                            </td>
                          </tr>
                          <tr> 
                            <td colspan="3" height="40" valign="middle" align="center">
                              <p>&nbsp;</p>
                              <p><a href="../../files/TOKENMON.ZIP"><b>Download Tokenmon 
                                (60 KB)</b></a></p>
                              <a href="../../files/TOKENSRC.ZIP"><b>Download Tokenmon 
                              plus Source (190 KB)</b></a> <br>
                              <br>
                              <a href="#top"><b>Back to Top</b></a> </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </TD>
              </TR>
            </TABLE>
            <!-- #EndEditable --></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
</body>
<!-- #EndTemplate --></html>
